<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Twitter Future - Merging</title>
  <meta name="description" content="I’ve been doing Scala development for a while now, but I’ve been firmly in the landof Lightbend (previously Typesafe) and haven’t ventured out as much as I s...">

  <!-- <link rel="stylesheet" href="/css/main.css"> -->
  
  <style>
    @import "https://fonts.googleapis.com/css?family=Roboto:300,400,500";body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,hr,dl,dd,ol,ul,figure{margin:0;padding:0}body{-webkit-text-size-adjust:100%;background-color:#fff;color:#566b78;font-family:"Roboto","Open Sans",Helvetica,Arial,sans-serif;font-size:18px;font-weight:300;line-height:1.5;padding-top:2em}h1,h2,strong{color:#344b78}h1,h2,h3,h4,h5,h6,p,blockquote,pre,ul,ol,dl,figure{margin-bottom:15px}img{max-width:100%;vertical-align:middle}figure>img{display:block}figcaption{font-size:15.75px}ul,ol{margin-left:30px}li>ul,li>ol{margin-bottom:0}h1,h2,h3,h4,h5,h6{font-weight:300}a{color:#e81c4f;text-decoration:none}a:visited{color:#e81c4f}a:hover{color:#566b78;text-decoration:none}blockquote{color:#828282;border-left:4px solid #e8e8e8;padding-left:15px;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}pre,code{font-size:12px;border-radius:3px;border:1px solid #d8dee9;background-color:#f5f7f9}code{padding:4px 5px 1px 5px}pre{padding:8px 12px;overflow-x:auto}pre>code{border:0;padding-right:0;padding-left:0}.wrapper{max-width:-webkit-calc(800px - (30px * 2));max-width:calc(800px - (30px * 2));margin-right:auto;margin-left:auto;padding-right:30px;padding-left:30px}@media screen and (max-width: 800px){.wrapper{max-width:-webkit-calc(800px - (30px));max-width:calc(800px - (30px));padding-right:15px;padding-left:15px}}.wrapper:after{content:"";display:table;clear:both}.icon>svg{display:inline-block;width:16px;height:16px;vertical-align:middle}.icon>svg path{fill:#828282}.masthead{color:#fff;background-color:#2a2a2a;min-width:270px}.masthead h1{color:#fff;font-weight:bold;font-family:"Lucida Console", Monaco, monospace}.masthead a{text-decoration:none}.masthead a:hover{text-decoration:none}.masthead a:active{text-decoration:none}.masthead-inner .sub{color:#666}.masthead-inner .sub a{color:#666}.masthead-inner .sub a:hover{color:#999}@media (min-width: 760px){.masthead-inner{padding:40px}.page-content{margin-left:40px;margin-right:40px}}@media (min-width: 990px){.masthead{position:fixed;top:0;left:0;bottom:0;width:25%;margin-bottom:0}.masthead-inner{position:absolute;top:0;right:0;left:0}.masthead h1{font-size:54px}.page-content{margin-left:35%;margin-right:10%;width:55%}}.page-content{padding:30px 0}.page-heading{font-size:20px}.post-list{margin-left:0;list-style:none}.post-list .post-title{margin-top:30px;margin-bottom:0;display:inline-block}.post-meta{color:#828282;display:inline-block;float:right;font-size:15.75px;margin-top:32px}.post-link{display:block;font-size:24px}.post-header{margin-bottom:30px}.post-title{font-size:42px;letter-spacing:-1px;line-height:1}@media screen and (max-width: 800px){.post-title{font-size:36px}}.post-content{margin-bottom:30px}.post-content h2{font-size:32px}@media screen and (max-width: 800px){.post-content h2{font-size:28px}}.post-content h3{font-size:26px}@media screen and (max-width: 800px){.post-content h3{font-size:22px}}.post-content h4{font-size:20px}@media screen and (max-width: 800px){.post-content h4{font-size:18px}}.footer-navigation{border-bottom:1px solid #e0e0e0;display:block;font-weight:bold;height:60px;margin:50px 0 40px 0;text-align:center}.footer-navigation .previous{display:block;margin:0 auto}.footer-navigation .next{display:block;margin:0 auto}@media (min-width: 760px){.footer-navigation{height:30px;padding-bottom:10px}.footer-navigation .previous{display:block;float:left;margin:0;text-align:left}.footer-navigation .next{display:block;float:right;margin:0;text-align:right}}.highlight{background:#ffffff}.highlight .c{color:#999988;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#999988;font-style:italic}.highlight .cp{color:#999999;font-weight:bold}.highlight .c1{color:#999988;font-style:italic}.highlight .cs{color:#999999;font-weight:bold;font-style:italic}.highlight .gd{color:#000000;background-color:#fdd}.highlight .gd .x{color:#000000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000000;background-color:#dfd}.highlight .gi .x{color:#000000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#445588;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:teal}.highlight .nb{color:#0086B3}.highlight .nc{color:#445588;font-weight:bold}.highlight .no{color:#0086b3}.highlight .ni{color:purple}.highlight .ne{color:#990000;font-weight:bold}.highlight .nf{color:#990000;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:navy}.highlight .nv{color:teal}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#0086b3}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#0086b3}.highlight .bp{color:#999}.highlight .vc{color:teal}.highlight .vg{color:teal}.highlight .vi{color:teal}.highlight .il{color:#099}.post .highlight .lineno{color:#ccc;display:inline-block;padding:0 5px 0 0;border-right:1px solid #ccc}.post .highlight pre code{display:block;white-space:pre;overflow-x:auto;word-wrap:normal}.post .highlight pre{border:none;border-left:3px solid #d8dee9;border-color:#e0e0e0}.post .highlight pre code{background-color:transparent;font-size:12px}

  </style>
  <link rel="canonical" href="http://www.johnmurray.io/draft/2016/06/15/Twitter-Future--Merge.html">
  <link rel="alternate" type="application/rss+xml" title="John Murray" href="http://www.johnmurray.io/feed.xml" />
</head>


  <body>

    <header class="masthead">
  <div class="masthead-inner">
    <a href="/"><h1>murray</h2></a>
    <p class="sub">
      <a href="http://github.com/johnmurray">github</a>
      |
      <a href="http://twitter.com/johnmurray_io">twitter</a>
      |
      <a href="http://linkedin.com/pub/john-murray/22/a86/80a/en">linkedin</a>
    </p>
    <p class="sub">&copy; 2016. All Rights Reserved</p>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

    <header class="post-header">
        <h1 class="post-title">Twitter Future - Merging</h1>
    </header>

    <article class="post-content">
        <p>I’ve been doing Scala development for a while now, but I’ve been firmly in the land
of Lightbend (previously Typesafe) and haven’t ventured out as much as I should have.
Within the past week I have been doing a lot of digging into Twitter’s Scala stack when
I came across their <code>Future</code> implementation. I’ve long known that this has existed, but I
wasn’t sure if it was still being used (it is) or what made it different. Doing a little
more digging I found a <a href="#todo (in evernote)">Google Groups discussion thread</a> on the topic.</p>

<p>There were a couple of interesting points as to what made Twitter’s <code>Future</code> different than
from what is found in the standard library. One was called “merging” which can essentially
be throught of as tail recursion for <code>Future</code>s. Let’s dig into this a little further.</p>

<h2 id="futuremap">Future#map</h2>

<p>If Twitter’s <code>Future</code>s are mergeable, then we should be able to witness this behavior within
the <code>map</code> function of a <code>Future</code>. Let’s look at the implementation.</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="lineno">1</span> <span class="k">def</span> <span class="n">map</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span>
<span class="lineno">2</span>   <span class="n">transform</span> <span class="o">{</span>
<span class="lineno">3</span>     <span class="k">case</span> <span class="nc">Return</span><span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Future</span> <span class="o">{</span> <span class="n">f</span><span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="o">}</span>
<span class="lineno">4</span>     <span class="k">case</span> <span class="n">t</span><span class="k">:</span> <span class="kt">Throw</span><span class="o">[</span><span class="k">_</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">.</span><span class="n">const</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span>
<span class="lineno">5</span>   <span class="o">}</span></code></pre></div>

<p>The first thing we notice is that the entire call is wrapped in a <code>transform</code> function. That seems
important and we’ll come back to that. What we’re passing to the <code>transform</code> function seems to
be a partial function with the type <code>Try[A] =&gt; Future[B]</code> (that’s a Twitter <code>Try</code> BTW). The function
itself seems what we would expect and isn’t really anything special. The point to note is that the
function assumes that the future is completed when it is ran, which means all of the interesting
logic is in <code>transform</code>.</p>

<h2 id="futuretransform">Future#transform</h2>

<p><code>transform</code> is abstractly defined on the <code>Future</code> abstract class.</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="lineno">1</span> <span class="k">def</span> <span class="n">transform</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span></code></pre></div>

<p>Since this method is abstract, and since <code>Future</code> is abstract, before we dig any deeper we need
to understand the types of concrete <code>Future</code>s taht exist and their intended use.</p>

<ul>
  <li><code>NoFuture</code> - A future that will never complete</li>
  <li><code>ConstFuture</code> - A future that has been completed</li>
  <li><code>Promise</code> - A completable future (writeable)</li>
</ul>

<p>I’m not yet sure the utility in a <code>NoFuture</code>, but a <code>ConstFuture</code> is usually what you would
see when “wrapping” a value as a <code>Future</code>.</p>

<h2 id="constfuturetransform">ConstFuture#transform</h2>

<p>Let’s start by examining the <code>transform</code> function of a <code>ConstFuture</code></p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="lineno"> 1</span> <span class="k">def</span> <span class="n">transform</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
<span class="lineno"> 2</span>   <span class="k">val</span> <span class="n">p</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Promise</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>
<span class="lineno"> 3</span>   <span class="k">val</span> <span class="n">saved</span> <span class="k">=</span> <span class="nc">Local</span><span class="o">.</span><span class="n">save</span><span class="o">()</span>
<span class="lineno"> 4</span>   <span class="nc">Scheduler</span><span class="o">.</span><span class="n">submit</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span> <span class="o">{</span>
<span class="lineno"> 5</span>     <span class="k">def</span> <span class="n">run</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 6</span>       <span class="k">val</span> <span class="n">current</span> <span class="k">=</span> <span class="nc">Local</span><span class="o">.</span><span class="n">save</span><span class="o">()</span>
<span class="lineno"> 7</span>       <span class="nc">Local</span><span class="o">.</span><span class="n">restore</span><span class="o">(</span><span class="n">saved</span><span class="o">)</span>
<span class="lineno"> 8</span>       <span class="k">val</span> <span class="n">computed</span> <span class="k">=</span> <span class="k">try</span> <span class="n">f</span><span class="o">(</span><span class="n">result</span><span class="o">)</span>
<span class="lineno"> 9</span>       <span class="k">catch</span> <span class="o">{</span>
<span class="lineno">10</span>         <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">NonLocalReturnControl</span><span class="o">[</span><span class="k">_</span><span class="o">]</span> <span class="k">=&gt;</span>
<span class="lineno">11</span>           <span class="nc">Future</span><span class="o">.</span><span class="n">exception</span><span class="o">(</span><span class="k">new</span> <span class="nc">FutureNonLocalReturnControl</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
<span class="lineno">12</span>         <span class="k">case</span> <span class="nc">NonFatal</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="k">=&gt;</span>
<span class="lineno">13</span>           <span class="nc">Future</span><span class="o">.</span><span class="n">exception</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
<span class="lineno">14</span>         <span class="k">case</span> <span class="n">t</span><span class="k">:</span> <span class="kt">Throwable</span> <span class="o">=&gt;</span>
<span class="lineno">15</span>           <span class="nc">Monitor</span><span class="o">.</span><span class="n">handle</span><span class="o">(</span><span class="n">t</span><span class="o">)</span>
<span class="lineno">16</span>           <span class="k">throw</span> <span class="n">t</span>
<span class="lineno">17</span>       <span class="o">}</span>
<span class="lineno">18</span>       <span class="k">finally</span> <span class="nc">Local</span><span class="o">.</span><span class="n">restore</span><span class="o">(</span><span class="n">current</span><span class="o">)</span>
<span class="lineno">19</span>       <span class="n">p</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">computed</span><span class="o">)</span>
<span class="lineno">20</span>     <span class="o">}</span>
<span class="lineno">21</span>   <span class="o">})</span>
<span class="lineno">22</span>   <span class="n">p</span>
<span class="lineno">23</span> <span class="o">}</span></code></pre></div>

<p><strong>TODO:</strong> explain suffs… lol</p>

<h2 id="promisetransform">Promise#transform</h2>

<p><strong>TODO:</strong> explain suffs… lol</p>



        <div class="footer-navigation">
            
                <span class="previous"><a href="/log/2016/03/31/Poor-Mans-Actors.html">
                    &laquo;Poor Man's Actors in Java
                </a></span>
            
            
                <span class="next"><a href="/log/2016/06/18/Dont-do-Open-Source.html">
                    Don't Do Open Source&raquo;
                </a></span>
            
        </div>

        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <!-- Footer Advertisement -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-8460014050417630"
             data-ad-slot="9924998708"
             data-ad-format="auto"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>

    </article>

</div>

      </div>
    </div>


    <!-- Google Analytics -->
    <script type="application/javascript">
      function downloadGoogleAnalytics() {
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-11511983-4']);
        _gaq.push(['_trackPageview']);
        (function() {
          var ga = document.createElement('script'); 
          ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(ga, s);
        })();
      }
			if (window.addEventListener) window.addEventListener("load", downloadGoogleAnalytics, false);
			else if (window.attachEvent) window.attachEvent("onload", downloadGoogleAnalytics);
			else                         window.onload = downloadGoogleAnalytics;
    </script>
  </body>

</html>
