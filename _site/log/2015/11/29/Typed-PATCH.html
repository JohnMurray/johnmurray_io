<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Typed PATCH</title>
  <meta name="description" content="When building web services we need to define a contract of how the servicewill operate and how the client should communicate with the service. One importantp...">

  <!-- <link rel="stylesheet" href="/css/main.css"> -->
  
  <style>
    @import "https://fonts.googleapis.com/css?family=Roboto:300,400,500";body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,hr,dl,dd,ol,ul,figure{margin:0;padding:0}body{-webkit-text-size-adjust:100%;background-color:#fff;color:#566b78;font-family:"Roboto","Open Sans",Helvetica,Arial,sans-serif;font-size:18px;font-weight:300;line-height:1.7;padding-top:2em}h1,h2,strong{color:#344b78}h1,h2,h3,h4,h5,h6,p,blockquote,pre,ul,ol,dl,figure{margin-bottom:15px}img{margin-bottom:20px;max-width:100%;vertical-align:middle}figure>img{display:block}figcaption{font-size:15.75px}ul,ol{margin-left:30px}li>ul,li>ol{margin-bottom:0}h1,h2,h3,h4,h5,h6{font-weight:300}a{color:#e81c4f;text-decoration:none}a:visited{color:#e81c4f}a:hover{color:#566b78;text-decoration:none}blockquote{color:#828282;border-left:4px solid #e8e8e8;padding-left:15px;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}pre,code{font-size:12px;border-radius:3px;border:1px solid #d8dee9;background-color:#f5f7f9}code{padding:4px 5px 1px 5px}pre{padding:8px 12px;overflow-x:auto}pre>code{border:0;padding-right:0;padding-left:0}.wrapper{max-width:-webkit-calc(800px - (30px * 2));max-width:calc(800px - (30px * 2));margin-right:auto;margin-left:auto;padding-right:30px;padding-left:30px}@media screen and (max-width: 800px){.wrapper{max-width:-webkit-calc(800px - (30px));max-width:calc(800px - (30px));padding-right:15px;padding-left:15px}}.wrapper:after{content:"";display:table;clear:both}.icon>svg{display:inline-block;width:16px;height:16px;vertical-align:middle}.icon>svg path{fill:#828282}.masthead{color:#fff;background-color:#2a2a2a;min-width:270px}.masthead h1{color:#fff;font-weight:400;font-family:"Roboto", "Lucida Console", Monaco, monospace}.masthead a{text-decoration:none}.masthead a:hover{text-decoration:none}.masthead a:active{text-decoration:none}.masthead-inner .sub{color:#666}.masthead-inner .sub a{color:#666}.masthead-inner .sub a:hover{color:#999}@media (min-width: 760px){.masthead-inner{padding:40px}.page-content{margin-left:40px;margin-right:40px}}@media (min-width: 990px){.masthead{position:fixed;top:0;left:0;bottom:0;width:25%;margin-bottom:0}.masthead-inner{position:absolute;top:0;right:0;left:0}.masthead h1{font-size:54px}.page-content{margin-left:35%;margin-right:10%;width:55%}}.page-content{padding:30px 0}.page-heading{font-size:20px}.post-list{margin-left:0;list-style:none}.post-list .post-title{margin-top:30px;margin-bottom:0;display:inline-block}.post-meta{color:#828282;display:inline-block;float:right;font-size:15.75px;margin-top:32px}.post-link{display:block;font-size:24px}.post-header{margin-bottom:30px}.post-title{font-size:42px;letter-spacing:-1px;line-height:1}@media screen and (max-width: 800px){.post-title{font-size:36px}}.post-content{margin-bottom:30px}.post-content h2{font-size:32px}@media screen and (max-width: 800px){.post-content h2{font-size:28px}}.post-content h3{font-size:26px}@media screen and (max-width: 800px){.post-content h3{font-size:22px}}.post-content h4{font-size:20px}@media screen and (max-width: 800px){.post-content h4{font-size:18px}}.footer-navigation{border-bottom:1px solid #e0e0e0;display:block;font-weight:bold;height:60px;margin:50px 0 40px 0;text-align:center}.footer-navigation .previous{display:block;margin:0 auto}.footer-navigation .next{display:block;margin:0 auto}@media (min-width: 760px){.footer-navigation{height:30px;padding-bottom:10px}.footer-navigation .previous{display:block;float:left;margin:0;text-align:left}.footer-navigation .next{display:block;float:right;margin:0;text-align:right}}.highlight{background:#ffffff;margin-bottom:20px;margin-top:20px}.highlight .c{color:#999988;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#999988;font-style:italic}.highlight .cp{color:#999999;font-weight:bold}.highlight .c1{color:#999988;font-style:italic}.highlight .cs{color:#999999;font-weight:bold;font-style:italic}.highlight .gd{color:#000000;background-color:#fdd}.highlight .gd .x{color:#000000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000000;background-color:#dfd}.highlight .gi .x{color:#000000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#445588;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:teal}.highlight .nb{color:#0086B3}.highlight .nc{color:#445588;font-weight:bold}.highlight .no{color:#0086b3}.highlight .ni{color:purple}.highlight .ne{color:#990000;font-weight:bold}.highlight .nf{color:#990000;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:navy}.highlight .nv{color:teal}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#0086b3}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#0086b3}.highlight .bp{color:#999}.highlight .vc{color:teal}.highlight .vg{color:teal}.highlight .vi{color:teal}.highlight .il{color:#099}figure.highlight{border-left:3px solid #e0e0e0}.post .highlight .lineno{color:#ccc;display:inline-block;padding:0 5px 0 0;border-right:1px solid #ccc}.post .highlight pre code{display:block;white-space:pre;overflow-x:auto;word-wrap:normal}.post .highlight pre{border:none;margin:0}.post .highlight pre code{background-color:transparent;font-size:12px}

  </style>
  <link rel="canonical" href="http://www.johnmurray.io/log/2015/11/29/Typed-PATCH.html">
  <link rel="alternate" type="application/rss+xml" title="John Murray" href="http://www.johnmurray.io/feed.xml" />
</head>


  <body>

    <header class="masthead">
  <div class="masthead-inner">
    <a href="/"><h1>murray</h2></a>
    <p class="sub">
      <a href="http://github.com/johnmurray">github</a>
      |
      <a href="http://twitter.com/johnmurray_io">twitter</a>
      |
      <a href="http://linkedin.com/pub/john-murray/22/a86/80a/en">linkedin</a>
    </p>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

    <header class="post-header">
        <h1 class="post-title">Typed PATCH</h1>
    </header>

    <article class="post-content">
        <p>When building web services we need to define a contract of how the service
will operate and how the client should communicate with the service. One important
piece to this is the data that the service returns (usually on read operations)
and the data the service expects to receive (usually on write operations). One
really fantastic way to do this, especially when working in a language like Scala,
is to use types.</p>

<p>If I were designing a simple service to manage contacts, I might define my type
to look like:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
                <span class="n">name</span><span class="k">:</span>         <span class="kt">String</span><span class="o">,</span>
                <span class="n">birthday</span><span class="k">:</span>     <span class="kt">Date</span><span class="o">,</span>
                <span class="n">email</span><span class="k">:</span>        <span class="kt">Email</span><span class="o">,</span>
                <span class="n">address</span><span class="k">:</span>      <span class="kt">Option</span><span class="o">[</span><span class="kt">Address</span><span class="o">],</span>
                <span class="n">createdOn</span><span class="k">:</span>    <span class="kt">Date</span><span class="o">,</span>
                <span class="n">lastModified</span><span class="k">:</span> <span class="kt">Date</span><span class="o">)</span></pre></td></tr></tbody></table></code></pre></figure>

<p>This type accurately represents what I believe a contact, in the context of my
API, is defined as. All pieces except <code class="highlighter-rouge">address</code> are required 
and I also expect a few meta-data fields to exist such as <code class="highlighter-rouge">id</code>, 
<code class="highlighter-rouge">createdOn</code> and <code class="highlighter-rouge">lastModified</code>. This type works great when defining objects
in my system, but it starts to break down as a definition for a contract with a
consumer of my web-service.</p>

<p>While this works decently well for read operations, where the full object
is returned, what does this look like for a create (<code class="highlighter-rouge">POST</code>) operation? To start I
no longer need any of what I’ll call <em>“system provided”</em> fields such as <code class="highlighter-rouge">id</code>, 
<code class="highlighter-rouge">createdOn</code> and <code class="highlighter-rouge">lastModified</code>. Some of you might be saying one of two things right
about now:</p>

<ol>
  <li>Default the fields to <code class="highlighter-rouge">null</code></li>
  <li>Make fields that aren’t required an <code class="highlighter-rouge">Option</code></li>
</ol>

<p>I’m going to stop you right now. The purpose of this type is <em>supposed</em> to be a way
to expose a contract to the user. Making fields that will <em>always</em> exist on reads
an <code class="highlighter-rouge">Option</code> is really just a lie and not very useful for defining a complete contract.
To truly use types as our contract here, we need to define a create-specific type.
In our case, it might look like:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">UserCreate</span><span class="o">(</span><span class="n">name</span><span class="k">:</span>     <span class="kt">String</span><span class="o">,</span>
                      <span class="n">birthday</span><span class="k">:</span> <span class="kt">Date</span><span class="o">,</span>
                      <span class="n">email</span><span class="k">:</span>    <span class="kt">Email</span><span class="o">,</span>
                      <span class="n">address</span><span class="k">:</span>  <span class="kt">Option</span><span class="o">[</span><span class="kt">Address</span><span class="o">])</span></pre></td></tr></tbody></table></code></pre></figure>

<p>This gets us where we want to be at the price of having to create and maintain another
type in our application.</p>

<p>Now it’s time to think about how we would support operations such as PATCH which
are based around the idea of partial edits. Since, by the nature of partial edits,
everything is optional you can see that we can’t use the same model that we used
for create. Also, since we will need to know the difference between null and absent,
we’ll need to use a <code class="highlighter-rouge">TriState</code> value to represent any types that are currently 
nullable (or non-required by our default model).</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">UserCreate</span><span class="o">(</span><span class="n">id</span><span class="k">:</span>       <span class="kt">Long</span><span class="o">,</span>
                      <span class="n">name</span><span class="k">:</span>     <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span>
                      <span class="n">birthday</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Date</span><span class="o">],</span>
                      <span class="n">email</span><span class="k">:</span>    <span class="kt">Option</span><span class="o">[</span><span class="kt">Email</span><span class="o">],</span>
                      <span class="n">address</span><span class="k">:</span>  <span class="kt">TriState</span><span class="o">[</span><span class="kt">Address</span><span class="o">])</span></pre></td></tr></tbody></table></code></pre></figure>

<p>In the above model, we assume <code class="highlighter-rouge">Option</code> to be a matter of presence (not nullability) and
<code class="highlighter-rouge">TriState</code> to represent both presence and nullability.</p>

<p>Ta-da! We now have models that represent create, read, and partial edit. With this, we can
now work on optimizing our workflow. I think the proper step is to define an
abstract language that can define our service contract and allow our tooling to
generate our corresponding models for us. As a matter of fact, this is what we do
in Fireglass (an internal web-service framework) used at my current employment.</p>

<p>However, this framework is not (yet, maybe someday) open source. After some quick
looking around, I came across an older project that aimed to solve the problem via
macros. While I don’t necessarily agree with the approach, it is a solution that is
available today.</p>

<p><a href="https://github.com/pathikrit/metarest">https://github.com/pathikrit/metarest</a></p>


        <div class="footer-navigation">
            
                <span class="previous"><a href="/log/2015/05/04/Web-Service-Data-Models-Null.html">
                    &laquo;Web Service Data Models - Null
                </a></span>
            
            
                <span class="next"><a href="/log/2016/03/31/Poor-Mans-Actors.html">
                    Poor Man's Actors in Java&raquo;
                </a></span>
            
        </div>
    </article>

    <footer style="text-align:center;">
      &copy; 2017. All Rights Reserved
    </footer>

</div>

      </div>
    </div>


    <!-- Google Analytics -->
    <script type="application/javascript">
      function downloadGoogleAnalytics() {
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-11511983-4']);
        _gaq.push(['_trackPageview']);
        (function() {
          var ga = document.createElement('script'); 
          ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(ga, s);
        })();
      }
			if (window.addEventListener) window.addEventListener("load", downloadGoogleAnalytics, false);
			else if (window.attachEvent) window.attachEvent("onload", downloadGoogleAnalytics);
			else                         window.onload = downloadGoogleAnalytics;
    </script>
  </body>

</html>
