<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Typed PATCH</title>
  <meta name="description" content="When building web services we need to define a contract of how the servicewill operate and how the client should communicate with the service. One importantp...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://www.johnmurray.io/log/2015/11/29/Typed-PATCH.html">
  <link rel="alternate" type="application/rss+xml" title="John Murray" href="http://www.johnmurray.io/feed.xml" />
</head>


  <body>

    <header class="masthead">
  <div class="masthead-inner">
    <a href="/"><h1>murray</h2></a>
    <p class="sub">
      <a href="http://github.com/johnmurray">github</a>
      |
      <a href="http://twitter.com/johnmurray_io">twitter</a>
      |
      <a href="http://linkedin.com/pub/john-murray/22/a86/80a/en">linkedin</a>
    </p>
    <p class="sub">&copy; 2015. All Rights Reserved</p>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

    <header class="post-header">
        <h1 class="post-title">Typed PATCH</h1>
    </header>

    <article class="post-content">
        <p>When building web services we need to define a contract of how the service
will operate and how the client should communicate with the service. One important
piece to this is the data that the service returns (usually on read operations)
and the data the service expects to receive (usually on write operations). One
really fantastic way to do this, especially when working in a language like Scala,
is to use types.</p>

<p>If I were designing a simple service to manage contacts, I might define my type
to look like:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="lineno">1</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
<span class="lineno">2</span>                 <span class="n">name</span><span class="k">:</span>         <span class="kt">String</span><span class="o">,</span>
<span class="lineno">3</span>                 <span class="n">birthday</span><span class="k">:</span>     <span class="kt">Date</span><span class="o">,</span>
<span class="lineno">4</span>                 <span class="n">email</span><span class="k">:</span>        <span class="kt">Email</span><span class="o">,</span>
<span class="lineno">5</span>                 <span class="n">address</span><span class="k">:</span>      <span class="kt">Option</span><span class="o">[</span><span class="kt">Address</span><span class="o">],</span>
<span class="lineno">6</span>                 <span class="n">createdOn</span><span class="k">:</span>    <span class="kt">Date</span><span class="o">,</span>
<span class="lineno">7</span>                 <span class="n">lastModified</span><span class="k">:</span> <span class="kt">Date</span><span class="o">)</span></code></pre></div>

<p>This type accurately represents what I believe a contact, in the context of my
API, is defined as. All pieces except <code>address</code> are required 
and I also expect a few meta-data fields to exist such as <code>id</code>, 
<code>createdOn</code> and <code>lastModified</code>. This type works great when defining objects
in my system, but it starts to break down as a definition for a contract with a
consumer of my web-service. </p>

<p>While this works decently well for read operations, where the full object
is returned, what does this look like for a create (<code>POST</code>) operation? To start I
no longer need any of what I’ll call <em>“system provided”</em> fields such as <code>id</code>, 
<code>createdOn</code> and <code>lastModified</code>. Some of you might be saying one of two things right
about now:</p>

<ol>
  <li>Default the fields to <code>null</code></li>
  <li>Make fields that aren’t required an <code>Option</code></li>
</ol>

<p>I’m going to stop you right now. The purpose of this type is <em>supposed</em> to be a way
to expose a contract to the user. Making fields that will <em>always</em> exist on reads
an <code>Option</code> is really just a lie and not very useful for defining a complete contract.
To truly use types as our contract here, we need to define a create-specific type.
In our case, it might look like:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="lineno">1</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">UserCreate</span><span class="o">(</span><span class="n">name</span><span class="k">:</span>     <span class="kt">String</span><span class="o">,</span>
<span class="lineno">2</span>                       <span class="n">birthday</span><span class="k">:</span> <span class="kt">Date</span><span class="o">,</span>
<span class="lineno">3</span>                       <span class="n">email</span><span class="k">:</span>    <span class="kt">Email</span><span class="o">,</span>
<span class="lineno">4</span>                       <span class="n">address</span><span class="k">:</span>  <span class="kt">Option</span><span class="o">[</span><span class="kt">Address</span><span class="o">])</span></code></pre></div>

<p>This gets us where we want to be at the price of having to create and maintain another
type in our application. </p>

<p>Now it’s time to think about how we would support operations such as PATCH which
are based around the idea of partial edits. Since, by the nature of partial edits,
everything is optional you can see that we can’t use the same model that we used
for create. Also, since we will need to know the difference between null and absent,
we’ll need to use a <code>TriState</code> value to represent any types that are currently 
nullable (or non-required by our default model).</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="lineno">1</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">UserCreate</span><span class="o">(</span><span class="n">id</span><span class="k">:</span>       <span class="kt">Long</span><span class="o">,</span>
<span class="lineno">2</span>                       <span class="n">name</span><span class="k">:</span>     <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span>
<span class="lineno">3</span>                       <span class="n">birthday</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Date</span><span class="o">],</span>
<span class="lineno">4</span>                       <span class="n">email</span><span class="k">:</span>    <span class="kt">Option</span><span class="o">[</span><span class="kt">Email</span><span class="o">],</span>
<span class="lineno">5</span>                       <span class="n">address</span><span class="k">:</span>  <span class="kt">TriState</span><span class="o">[</span><span class="kt">Address</span><span class="o">])</span></code></pre></div>

<p>In the above model, we assume <code>Option</code> to be a matter of presence (not nullability) and
<code>TriState</code> to represent both presence and nullability.</p>

<p>Ta-da! We now have models that represent create, read, and partial edit. With this, we can
now work on optimizing our workflow. I think the proper step is to define an
abstract language that can define our service contract and allow our tooling to
generate our corresponding models for us. As a matter of fact, this is what we do
in Fireglass (an internal web-service framework) used at <a href="http://appnexus.com">AppNexus</a>.</p>

<p>However, this framework is not (yet, maybe someday) open source. After some quick
looking around, I came across an older project that aimed to solve the problem via
macros. While I don’t necessarily agree with the approach, it is a solution that is
available today.</p>

<p><a href="https://github.com/pathikrit/metarest">https://github.com/pathikrit/metarest</a></p>


        <br /> <br />
        <hr />
        <br /> <br />

        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <!-- Footer Advertisement -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-8460014050417630"
             data-ad-slot="9924998708"
             data-ad-format="auto"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
        
    </article>

</div>

      </div>
    </div>


    <!-- Google Analytics -->
    <script type="application/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11511983-4']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); 
        ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>

</html>
