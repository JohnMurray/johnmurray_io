<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Copy to Learn</title>
  <meta name="description" content="While I have stated my opinion in the past that you should think twice beforecreating another web framework, it can be a useful tool. In particular, if youar...">

  <!-- <link rel="stylesheet" href="/css/main.css"> -->
  
  <style>
    @import "https://fonts.googleapis.com/css?family=Roboto:300,400,500";body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,hr,dl,dd,ol,ul,figure{margin:0;padding:0}body{-webkit-text-size-adjust:100%;background-color:#fff;color:#566b78;font-family:"Roboto","Open Sans",Helvetica,Arial,sans-serif;font-size:18px;font-weight:300;line-height:1.7;padding-top:2em}h1,h2,strong{color:#344b78}h1,h2,h3,h4,h5,h6,p,blockquote,pre,ul,ol,dl,figure{margin-bottom:15px}img{margin-bottom:20px;max-width:100%;vertical-align:middle}figure>img{display:block}figcaption{font-size:15.75px}ul,ol{margin-left:30px}li>ul,li>ol{margin-bottom:0}h1,h2,h3,h4,h5,h6{font-weight:300}a{color:#e81c4f;text-decoration:none}a:visited{color:#e81c4f}a:hover{color:#566b78;text-decoration:none}blockquote{color:#828282;border-left:4px solid #e8e8e8;padding-left:15px;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}pre,code{font-size:12px;border-radius:3px;border:1px solid #d8dee9;background-color:#f5f7f9}code{padding:4px 5px 1px 5px}pre{padding:8px 12px;overflow-x:auto}pre>code{border:0;padding-right:0;padding-left:0}.wrapper{max-width:-webkit-calc(800px - (30px * 2));max-width:calc(800px - (30px * 2));margin-right:auto;margin-left:auto;padding-right:30px;padding-left:30px}@media screen and (max-width: 800px){.wrapper{max-width:-webkit-calc(800px - (30px));max-width:calc(800px - (30px));padding-right:15px;padding-left:15px}}.wrapper:after{content:"";display:table;clear:both}.icon>svg{display:inline-block;width:16px;height:16px;vertical-align:middle}.icon>svg path{fill:#828282}.masthead{color:#fff;background-color:#2a2a2a;min-width:270px}.masthead h1{color:#fff;font-weight:400;font-family:"Roboto", "Lucida Console", Monaco, monospace}.masthead a{text-decoration:none}.masthead a:hover{text-decoration:none}.masthead a:active{text-decoration:none}.masthead-inner .sub{color:#666}.masthead-inner .sub a{color:#666}.masthead-inner .sub a:hover{color:#999}@media (min-width: 760px){.masthead-inner{padding:40px}.page-content{margin-left:40px;margin-right:40px}}@media (min-width: 990px){.masthead{position:fixed;top:0;left:0;bottom:0;width:25%;margin-bottom:0}.masthead-inner{position:absolute;top:0;right:0;left:0}.masthead h1{font-size:54px}.page-content{margin-left:35%;margin-right:10%;width:55%}}.page-content{padding:30px 0}.page-heading{font-size:20px}.post-list{margin-left:0;list-style:none}.post-list .post-title{margin-top:30px;margin-bottom:0;display:inline-block}.post-meta{color:#828282;display:inline-block;float:right;font-size:15.75px;margin-top:32px}.post-link{display:block;font-size:24px}.post-header{margin-bottom:30px}.post-title{font-size:42px;letter-spacing:-1px;line-height:1}@media screen and (max-width: 800px){.post-title{font-size:36px}}.post-content{margin-bottom:30px}.post-content h2{font-size:32px}@media screen and (max-width: 800px){.post-content h2{font-size:28px}}.post-content h3{font-size:26px}@media screen and (max-width: 800px){.post-content h3{font-size:22px}}.post-content h4{font-size:20px}@media screen and (max-width: 800px){.post-content h4{font-size:18px}}.footer-navigation{border-bottom:1px solid #e0e0e0;display:block;font-weight:bold;height:60px;margin:50px 0 40px 0;text-align:center}.footer-navigation .previous{display:block;margin:0 auto}.footer-navigation .next{display:block;margin:0 auto}@media (min-width: 760px){.footer-navigation{height:30px;padding-bottom:10px}.footer-navigation .previous{display:block;float:left;margin:0;text-align:left}.footer-navigation .next{display:block;float:right;margin:0;text-align:right}}.highlight{background:#ffffff;margin-bottom:20px;margin-top:20px}.highlight .c{color:#999988;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#999988;font-style:italic}.highlight .cp{color:#999999;font-weight:bold}.highlight .c1{color:#999988;font-style:italic}.highlight .cs{color:#999999;font-weight:bold;font-style:italic}.highlight .gd{color:#000000;background-color:#fdd}.highlight .gd .x{color:#000000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000000;background-color:#dfd}.highlight .gi .x{color:#000000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#445588;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:teal}.highlight .nb{color:#0086B3}.highlight .nc{color:#445588;font-weight:bold}.highlight .no{color:#0086b3}.highlight .ni{color:purple}.highlight .ne{color:#990000;font-weight:bold}.highlight .nf{color:#990000;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:navy}.highlight .nv{color:teal}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#0086b3}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#0086b3}.highlight .bp{color:#999}.highlight .vc{color:teal}.highlight .vg{color:teal}.highlight .vi{color:teal}.highlight .il{color:#099}.post .highlight .lineno{color:#ccc;display:inline-block;padding:0 5px 0 0;border-right:1px solid #ccc}.post .highlight pre code{display:block;white-space:pre;overflow-x:auto;word-wrap:normal}.post .highlight pre{border:none;border-left:3px solid #d8dee9;border-color:#e0e0e0}.post .highlight pre code{background-color:transparent;font-size:12px}

  </style>
  <link rel="canonical" href="http://www.johnmurray.io/log/2013/03/11/Copy-to-Learn.html">
  <link rel="alternate" type="application/rss+xml" title="John Murray" href="http://www.johnmurray.io/feed.xml" />
</head>


  <body>

    <header class="masthead">
  <div class="masthead-inner">
    <a href="/"><h1>murray</h2></a>
    <p class="sub">
      <a href="http://github.com/johnmurray">github</a>
      |
      <a href="http://twitter.com/johnmurray_io">twitter</a>
      |
      <a href="http://linkedin.com/pub/john-murray/22/a86/80a/en">linkedin</a>
    </p>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

    <header class="post-header">
        <h1 class="post-title">Copy to Learn</h1>
    </header>

    <article class="post-content">
        <p>While I have stated my opinion in the past that you should think twice before
creating another web framework, it can be a useful tool. In particular, if you
are familiar with a web framework in your language of choice, it may be a
good learning exercise to try and implement that framework in another
language. <strong>Note</strong> however that you should likely not try to get people to use
your new framework if it is only for learning purposes. If you are seriously
considering creating a new web framework, please read my post <a href="/log/2012/04/19/New-Web-Frameworks.html">New Web
Frameworks</a>.</p>

<h2 id="background">Background</h2>
<p>I’ve recently (as of the time this post was written) taken a new position in
AdTech doing PHP for the purpose of web services. I really don’t know too much
about PHP and it’s been a while since I’ve last encountered real PHP code. So,
I figured that a little homework was in order.</p>

<p>I figured that the best way to learn would be to create a fun project in PHP
that could utilize many of PHP’s newer features. For this, I wanted to create
a (very) simple clone of my favorite web-app framework, <a href="http://sinatrarb.com">Sinatra</a>.</p>

<h2 id="goals">Goals</h2>

<p>Obviously the main goal is to better learn PHP’s main language features, but
let’s talk more about what the goal of the project will be:</p>

<ul>
  <li>Implement basic Sinatra/HTTP routing methods (GET, POST, PUT, DELETE)</li>
  <li>Provide pre and post hooks</li>
  <li>Implement parameratized routes in Sinatra fashion</li>
  <li>Use lambdas to provide an <em>authentic</em> Sinatra-experience</li>
  <li>Use PHP 5.4 features (where possible/applicable)</li>
</ul>

<h2 id="result">Result</h2>

<p>The result is a framework called Pinatra (to make it even more obvious my
intent) that is available on my Github <a href="https://github.com/JohnMurray/pinatra">here</a>. Let’s see how well I did
at meeting the aforementioned goals:</p>

<h3 id="basic-routing">Basic Routing</h3>

<p>This was relatively simple. To get started, I created a main class <code>Pinatra</code>
that I could use to register my routes with. I then created methods for each
HTTP verb I would be supporting (GET, POST, PUT, DELETE) that took a path (a
string) and a handler. The handler would then be called if the incoming
request could be matched against the route. The method for registering a GET
request looked generally like:</p>

<div class="highlight"><pre><code class="language-php5" data-lang="php5"><span class="lineno">1</span> <span class="x">public static function get($match, $callback) {</span>
<span class="lineno">2</span> <span class="x">  $app = Pinatra::instance();</span>
<span class="lineno">3</span> <span class="x">  $app-&gt;register(&#39;get&#39;, $match, $callback);</span>
<span class="lineno">4</span> <span class="x">}</span></code></pre></div>

<p>As you can see, we are simply taking the route to match (the <code>$match</code>) and a
callback (a callable) and sending that on to the <code>register</code> function. So, to
look at the register function:</p>

<div class="highlight"><pre><code class="language-php5" data-lang="php5"><span class="lineno">1</span> <span class="x">private function register($method, $match, $callback) {</span>
<span class="lineno">2</span> <span class="x">  $match = $this-&gt;compute_regex($match);</span>
<span class="lineno">3</span> <span class="x">  $this-&gt;routes[$method][$match] = $callback;</span>
<span class="lineno">4</span> <span class="x">}</span></code></pre></div>

<p>You can see here that we are extracting a regex out of the given match (we’ll
look more at that later) and we are registering the route in a local hash based
on the HTTP verb (<code>$method</code>).</p>

<p>We can use this very simply now as:</p>

<div class="highlight"><pre><code class="language-php5" data-lang="php5"><span class="lineno">1</span> <span class="x">Pinatra::get(&#39;/hi&#39;, function () {</span>
<span class="lineno">2</span> <span class="x">  return &#39;hello world&#39;;</span>
<span class="lineno">3</span> <span class="x">});</span></code></pre></div>

<p>Very similar, we can register POST method like the following:</p>

<div class="highlight"><pre><code class="language-php5" data-lang="php5"><span class="lineno">1</span> <span class="x">Pinatra::post(&#39;/name&#39;, function ($data) {</span>
<span class="lineno">2</span> <span class="x">  return &#39;Hello &#39; . $data[&#39;name&#39;];</span>
<span class="lineno">3</span> <span class="x">});</span></code></pre></div>

<h3 id="prepost-hooks">Pre/Post Hooks</h3>

<p>Using the same functionality used to register the routes on a particular HTTP
verb, we can also register before and after hooks. When we create them in our
application, it is as simple as:</p>

<div class="highlight"><pre><code class="language-php5" data-lang="php5"><span class="lineno">1</span> <span class="x">Pinatra::before(&#39;*&#39;, function () {</span>
<span class="lineno">2</span> <span class="x">  header(&#39;AppVersion: 0.0.1&#39;);</span>
<span class="lineno">3</span> <span class="x">});</span></code></pre></div>

<div class="highlight"><pre><code class="language-php5" data-lang="php5"><span class="lineno">1</span> <span class="x">Pinatra::after(&#39;*&#39;, function () {</span>
<span class="lineno">2</span> <span class="x">  Logger::log_request(&#39;served yet another request&#39;);</span>
<span class="lineno">3</span> <span class="x">});</span></code></pre></div>

<h3 id="parameratized-routes">Parameratized Routes</h3>

<p>This is a way of representing data in a given route that is extracted
automatically. For example, given the following route:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text"><span class="lineno">1</span> /authors/:author_id/books/:book_id</code></pre></div>

<p>I should be able to extract the two values, <code>:author_id</code> and <code>:book_id</code>.
Earlier you saw a method for building up the regular expression. This is
what we’ll use to create our route and the match-patterns will be used
to extract the route-data. The method for generating our regex from the
user-supplied route is seen below.</p>

<div class="highlight"><pre><code class="language-php5" data-lang="php5"><span class="lineno"> 1</span> <span class="x">private $URIParser_PLACEHOLDER = &#39;([^\/]+)&#39;;</span>
<span class="lineno"> 2</span> <span class="x">private $URIParser_GLOB = &#39;.*?&#39;;</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> <span class="x">/**</span>
<span class="lineno"> 5</span> <span class="x"> * Private: Generate a PHP (Perl) regular expression given the</span>
<span class="lineno"> 6</span> <span class="x"> *          Sinatra-style expression in the get/post/put/etc. functions.</span>
<span class="lineno"> 7</span> <span class="x"> */</span>
<span class="lineno"> 8</span> <span class="x">private function compute_regex($match) {</span>
<span class="lineno"> 9</span> <span class="x">  // get the URI parts of the match-pattern given</span>
<span class="lineno">10</span> <span class="x">  $parts = array_filter(explode(&#39;/&#39;, $match), function ($val) { </span>
<span class="lineno">11</span> <span class="x">    return !empty($val);</span>
<span class="lineno">12</span> <span class="x">  });</span>
<span class="lineno">13</span> 
<span class="lineno">14</span> <span class="x">  // build our pattern-matching regex from given route</span>
<span class="lineno">15</span> <span class="x">  $regex= &#39;/^&#39;;</span>
<span class="lineno">16</span> 
<span class="lineno">17</span> <span class="x">  foreach ($parts as $part) {</span>
<span class="lineno">18</span> <span class="x">    if ($part[0] === &#39;:&#39;) {</span>
<span class="lineno">19</span> <span class="x">      $regex .= &#39;\/&#39; . $this-&gt;URIParser_PLACEHOLDER;</span>
<span class="lineno">20</span> <span class="x">    }</span>
<span class="lineno">21</span> <span class="x">    else if ($part[0] === &#39;*&#39;){</span>
<span class="lineno">22</span> <span class="x">      $regex .= &#39;\/&#39; . $this-&gt;URIParser_GLOB;</span>
<span class="lineno">23</span> <span class="x">    }</span>
<span class="lineno">24</span> <span class="x">    else {</span>
<span class="lineno">25</span> <span class="x">      $regex .= &#39;\/&#39; . $part;</span>
<span class="lineno">26</span> <span class="x">    }</span>
<span class="lineno">27</span> <span class="x">  }</span>
<span class="lineno">28</span> <span class="x">  $regex .= &#39;\/?$/&#39;;</span>
<span class="lineno">29</span> <span class="x">  return $regex;</span>
<span class="lineno">30</span> <span class="x">}</span></code></pre></div>

<p>You can see how the match patterns could be used to extract data from
the URI. This can then be passed to the route-methods. An example of how
this would look is as such:</p>

<div class="highlight"><pre><code class="language-php5" data-lang="php5"><span class="lineno">1</span> <span class="x">Pinatra::get(&#39;/hello/:name&#39;, function($name) {</span>
<span class="lineno">2</span> <span class="x">  return $this-&gt;json([</span>
<span class="lineno">3</span> <span class="x">    &#39;key&#39; =&gt; &#39;hello-route has been matched!&#39;, </span>
<span class="lineno">4</span> <span class="x">    &#39;name&#39; =&gt; $name</span>
<span class="lineno">5</span> <span class="x">  ]);</span>
<span class="lineno">6</span> <span class="x">});</span></code></pre></div>

<p>You’ll also notice a JSON helper function (I’ll leave that one for your own
exploration).</p>

<h3 id="lambdas">Lambdas</h3>

<p>You’ve already seen the use of lambdas (anonymous functions) in my examples
so far, so suffice it to say, I met that goal. One important thing to note is
that newer versions of PHP provide easy way to rebind anonymous methods making
it possible to use them here. Take a look at the method that actually matches
a request to a route and calls a lambda:</p>

<div class="highlight"><pre><code class="language-php5" data-lang="php5"><span class="lineno"> 1</span> <span class="x">/**</span>
<span class="lineno"> 2</span> <span class="x">   * Method that is called when we actually want to process an incoming</span>
<span class="lineno"> 3</span> <span class="x">   * request based on the method and uri provided. This method (expecting</span>
<span class="lineno"> 4</span> <span class="x">   * to be given a URI and method) can also be used for re-routing requests</span>
<span class="lineno"> 5</span> <span class="x">   * internally.</span>
<span class="lineno"> 6</span> <span class="x">   */</span>
<span class="lineno"> 7</span> <span class="x">public static function handle_request($method, $uri) {</span>
<span class="lineno"> 8</span> <span class="x">  $app = Pinatra::instance();</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="x">  // before hook code (removed for brevity)</span>
<span class="lineno">12</span> 
<span class="lineno">13</span> <span class="x">  // find and call route-handler</span>
<span class="lineno">14</span> <span class="x">  $route_match = $app-&gt;find_route($app-&gt;routes, $method, $uri);</span>
<span class="lineno">15</span> <span class="x">  if ($route_match !== null) {</span>
<span class="lineno">16</span> <span class="x">      </span>
<span class="lineno">17</span> <span class="x">    $request_body_data = $app-&gt;get_body_data($method);</span>
<span class="lineno">18</span> <span class="x">    if ($request_body_data !== null) {</span>
<span class="lineno">19</span> <span class="x">      array_unshift($route_match[&#39;arguments&#39;], $request_body_data);</span>
<span class="lineno">20</span> <span class="x">    }</span>
<span class="lineno">21</span> 
<span class="lineno">22</span> <span class="x">    $route_res = call_user_func_array(</span>
<span class="lineno">23</span> <span class="x">      $route_match[&#39;callback&#39;]-&gt;bindTo($app), </span>
<span class="lineno">24</span> <span class="x">      $route_match[&#39;arguments&#39;]);</span>
<span class="lineno">25</span> <span class="x">  }</span>
<span class="lineno">26</span> 
<span class="lineno">27</span> <span class="x">  // after hook code (removed for brevity)</span>
<span class="lineno">28</span> <span class="x">  </span>
<span class="lineno">29</span> <span class="x">}</span></code></pre></div>

<h3 id="php-54-usage">PHP 5.4 Usage</h3>

<p>Several features were used, but the main new 5.4’ish feature that got used
was traits. They were fun, but I probably used them wrong. Anyways, I’ll leave it
up to you to check out my usage, however I will say that I mainly used them
as modules and not so much as re-usable traits.</p>

<h2 id="what-was-learned">What Was Learned</h2>

<p>While I already knew that a PHP script ran every time a new request was made,
I learned that PHP may not be the best language in which to implement a
Sinatra-like <a href="http://en.wikipedia.org/wiki/Domain-specific_language">DSL</a>. Simply put, we must register all of the routes on every
request. Since we cannot cache these results, we end up doing a lot of parsing
and string manipulation on every request. This means that as you add new routes,
you incur overhead on every new request, even if that route is never called.
This is unlike other languages in which the application starts up once and then
those computed routes (regex’s) can be cached and re-used.</p>

<h2 id="final-notes">Final Notes</h2>

<p>Like I had mentioned previously, this project was to learn. That being said, there
is probably a lot of debug code and comments left in this project and I would not
recommend it for real-world use. So, if you do want to play around with it, you might
have to remove some <code>echo</code> and <code>var_dump</code> statements that might still be hanging
around in the code.</p>



        <div class="footer-navigation">
            
                <span class="previous"><a href="/log/2013/01/16/Metric-K-Center-A.html">
                    &laquo;Metric K-Center [A]
                </a></span>
            
            
                <span class="next"><a href="/log/2013/07/15/SSH-FS-Script.html">
                    SSH FS Script&raquo;
                </a></span>
            
        </div>
    </article>

    <footer style="text-align:center;">
      &copy; 2017. All Rights Reserved
    </footer>

</div>

      </div>
    </div>


    <!-- Google Analytics -->
    <script type="application/javascript">
      function downloadGoogleAnalytics() {
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-11511983-4']);
        _gaq.push(['_trackPageview']);
        (function() {
          var ga = document.createElement('script'); 
          ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(ga, s);
        })();
      }
			if (window.addEventListener) window.addEventListener("load", downloadGoogleAnalytics, false);
			else if (window.attachEvent) window.attachEvent("onload", downloadGoogleAnalytics);
			else                         window.onload = downloadGoogleAnalytics;
    </script>
  </body>

</html>
